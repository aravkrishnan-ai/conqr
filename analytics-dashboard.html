<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conqr Analytics Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }

  /* Login */
  #login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
  .login-box { background: #1a1a1a; border: 1px solid #333; border-radius: 16px; padding: 40px; max-width: 480px; width: 100%; }
  .login-box h1 { font-size: 24px; margin-bottom: 8px; color: #fff; }
  .login-box p { color: #888; margin-bottom: 24px; font-size: 14px; line-height: 1.5; }
  .login-box label { display: block; font-size: 13px; color: #aaa; margin-bottom: 6px; }
  .login-box input { width: 100%; padding: 12px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; margin-bottom: 16px; font-family: monospace; }
  .login-box input:focus { outline: none; border-color: #E65100; }
  .login-box button { width: 100%; padding: 14px; background: #E65100; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
  .login-box button:hover { background: #ff6d00; }
  .login-box .error { color: #ff4444; font-size: 13px; margin-bottom: 12px; display: none; }
  .login-box .hint { background: #1f1f1f; border: 1px solid #2a2a2a; border-radius: 8px; padding: 12px; margin-bottom: 20px; }
  .login-box .hint code { color: #E65100; font-size: 13px; }

  /* Dashboard */
  #dashboard { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
  .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 12px; }
  .header h1 { font-size: 28px; color: #fff; }
  .header-actions { display: flex; gap: 12px; align-items: center; }
  .btn-sm { padding: 8px 16px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; cursor: pointer; font-size: 13px; }
  .btn-sm:hover { background: #252525; }
  .btn-sm.active { background: #E65100; border-color: #E65100; color: #fff; }
  .last-refresh { color: #666; font-size: 12px; }

  /* Metric Cards */
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .metric-card { background: #1a1a1a; border: 1px solid #252525; border-radius: 12px; padding: 20px; }
  .metric-card .label { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .metric-card .value { font-size: 32px; font-weight: 700; color: #fff; }
  .metric-card .sub { font-size: 13px; color: #666; margin-top: 4px; }

  /* Grid */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

  /* Panels */
  .panel { background: #1a1a1a; border: 1px solid #252525; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
  .panel h2 { font-size: 18px; color: #fff; margin-bottom: 16px; }
  .panel canvas { max-height: 300px; }

  /* Tables */
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 10px 12px; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #252525; }
  td { padding: 10px 12px; font-size: 14px; border-bottom: 1px solid #1f1f1f; }
  tr:hover td { background: #1f1f1f; }
  .rank-1 { color: #ffd700; font-weight: 700; }
  .rank-2 { color: #c0c0c0; font-weight: 600; }
  .rank-3 { color: #cd7f32; font-weight: 600; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
  .tag-error { background: #3a1111; color: #ff6666; }
  .tag-crash { background: #3a1111; color: #ff4444; }
  .empty-state { text-align: center; padding: 40px 20px; color: #555; }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }

  /* Loading */
  .loading { text-align: center; padding: 60px; color: #666; }
  .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #333; border-top-color: #E65100; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="login-screen">
  <div class="login-box">
    <h1>Conqr Analytics</h1>
    <p>Enter your Supabase service role key to view tester analytics. Your key is only stored in this browser tab and never saved.</p>
    <div class="hint">
      <label>Where to find it:</label>
      <code>Supabase Dashboard > Settings > API > service_role key</code>
    </div>
    <div class="error" id="login-error"></div>
    <label>Supabase URL</label>
    <input type="text" id="input-url" value="https://ckrdbwqklcxsfcnlfdvi.supabase.co" />
    <label>Service Role Key (secret)</label>
    <input type="password" id="input-key" placeholder="eyJhbGciOiJIUzI1NiIs..." />
    <button onclick="connectAndLoad()">Connect</button>
  </div>
</div>

<div id="dashboard">
  <div class="header">
    <h1>Conqr Analytics</h1>
    <div class="header-actions">
      <span class="last-refresh" id="last-refresh"></span>
      <button class="btn-sm" onclick="refreshAll()">Refresh</button>
      <button class="btn-sm" onclick="logout()">Disconnect</button>
    </div>
  </div>

  <div class="metrics" id="metrics"></div>

  <div class="grid-2">
    <div class="panel">
      <h2>Daily Active Users</h2>
      <canvas id="chart-dau"></canvas>
    </div>
    <div class="panel">
      <h2>Screen Popularity</h2>
      <canvas id="chart-screens"></canvas>
    </div>
  </div>

  <div class="panel">
    <h2>Feature Adoption (Daily)</h2>
    <div id="feature-table"></div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <h2>User Engagement</h2>
      <div id="user-table"></div>
    </div>
    <div class="panel">
      <h2>Recent Errors</h2>
      <div id="error-table"></div>
    </div>
  </div>

  <div class="panel">
    <h2>Recent Sessions</h2>
    <div id="session-table"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
let sb = null;
let dauChart = null;
let screenChart = null;

async function connectAndLoad() {
  const url = document.getElementById('input-url').value.trim();
  const key = document.getElementById('input-key').value.trim();
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';

  if (!url || !key) {
    errEl.textContent = 'Please fill in both fields.';
    errEl.style.display = 'block';
    return;
  }

  // Debug step 1: Check if supabase-js loaded
  if (!window.supabase || !window.supabase.createClient) {
    errEl.innerHTML = '<b>Error:</b> Supabase JS library failed to load from CDN.<br>Check your internet connection and try refreshing the page.';
    errEl.style.display = 'block';
    return;
  }

  // Debug step 2: Test raw API connectivity first
  try {
    const testUrl = url.replace(/\/$/, '') + '/rest/v1/analytics_events?select=count&limit=0';
    const rawRes = await fetch(testUrl, {
      headers: {
        'apikey': key,
        'Authorization': 'Bearer ' + key,
      },
    });

    if (!rawRes.ok) {
      const body = await rawRes.text();
      let parsed = {};
      try { parsed = JSON.parse(body); } catch(e) {}
      errEl.innerHTML = '<b>API Error (HTTP ' + rawRes.status + '):</b><br>' +
        (parsed.message || body || 'Unknown error') +
        (parsed.hint ? '<br><i>Hint: ' + parsed.hint + '</i>' : '') +
        '<br><br><b>Check:</b> Make sure you are pasting the <code>service_role</code> key (starts with <code>eyJ...</code>), not the anon key.';
      errEl.style.display = 'block';
      return;
    }
  } catch (fetchErr) {
    errEl.innerHTML = '<b>Network error:</b> Could not reach Supabase at<br><code>' + url + '</code><br><br>' + fetchErr.message;
    errEl.style.display = 'block';
    return;
  }

  // Debug step 3: Create client and load dashboard
  try {
    sb = window.supabase.createClient(url, key, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
        detectSessionInUrl: false,
      },
    });

    const { count, error } = await sb.from('analytics_events').select('*', { count: 'exact', head: true });
    if (error) {
      errEl.innerHTML = '<b>Query error:</b> ' + error.message +
        (error.hint ? '<br><i>Hint: ' + error.hint + '</i>' : '') +
        (error.code ? '<br>Code: ' + error.code : '');
      errEl.style.display = 'block';
      return;
    }

    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    await refreshAll();
  } catch (err) {
    errEl.innerHTML = '<b>Connection failed:</b> ' + (err.message || 'Unknown error') +
      '<br><pre style="margin-top:8px;font-size:11px;color:#888;white-space:pre-wrap">' + (err.stack || '') + '</pre>';
    errEl.style.display = 'block';
  }
}

function logout() {
  sb = null;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('input-key').value = '';
}

async function refreshAll() {
  document.getElementById('last-refresh').textContent = 'Refreshing...';
  try {
    await Promise.all([
      loadMetrics(),
      loadDAU(),
      loadScreens(),
      loadFeatures(),
      loadUsers(),
      loadErrors(),
      loadSessions(),
    ]);
    document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch (err) {
    document.getElementById('last-refresh').textContent = 'Refresh failed';
    console.error(err);
  }
}

// ---- METRICS ----
async function loadMetrics() {
  const [
    { count: totalEvents },
    { count: totalSessions },
    { data: users },
    { data: todayDAU },
  ] = await Promise.all([
    sb.from('analytics_events').select('*', { count: 'exact', head: true }),
    sb.from('analytics_events').select('*', { count: 'exact', head: true }).eq('event_type', 'session_start'),
    sb.from('analytics_events').select('user_id').eq('event_type', 'session_start'),
    sb.from('analytics_events').select('user_id').eq('event_type', 'session_start').gte('created_at', new Date(new Date().setHours(0,0,0,0)).toISOString()),
  ]);

  const uniqueUsers = new Set((users || []).map(u => u.user_id)).size;
  const todayUsers = new Set((todayDAU || []).map(u => u.user_id)).size;

  const { count: totalErrors } = await sb.from('analytics_events').select('*', { count: 'exact', head: true }).in('event_type', ['error', 'crash']);
  const { count: totalActivities } = await sb.from('analytics_events').select('*', { count: 'exact', head: true }).eq('event_type', 'activity_completed');
  const { count: totalTerritories } = await sb.from('analytics_events').select('*', { count: 'exact', head: true }).eq('event_type', 'territory_claimed');

  document.getElementById('metrics').innerHTML = `
    <div class="metric-card"><div class="label">Today's Active Users</div><div class="value">${todayUsers}</div><div class="sub">unique users today</div></div>
    <div class="metric-card"><div class="label">Total Users</div><div class="value">${uniqueUsers}</div><div class="sub">all time</div></div>
    <div class="metric-card"><div class="label">Total Sessions</div><div class="value">${fmt(totalSessions || 0)}</div><div class="sub">app opens</div></div>
    <div class="metric-card"><div class="label">Total Events</div><div class="value">${fmt(totalEvents || 0)}</div><div class="sub">tracked actions</div></div>
    <div class="metric-card"><div class="label">Activities Completed</div><div class="value">${fmt(totalActivities || 0)}</div><div class="sub">runs, walks, rides</div></div>
    <div class="metric-card"><div class="label">Territories Claimed</div><div class="value">${fmt(totalTerritories || 0)}</div><div class="sub">conquered areas</div></div>
    <div class="metric-card"><div class="label">Errors</div><div class="value">${fmt(totalErrors || 0)}</div><div class="sub">errors + crashes</div></div>
  `;
}

// ---- DAU CHART ----
async function loadDAU() {
  const { data } = await sb.from('analytics_events')
    .select('user_id, created_at')
    .eq('event_type', 'session_start')
    .order('created_at', { ascending: true });

  if (!data || data.length === 0) return renderEmpty('chart-dau');

  const byDay = {};
  data.forEach(row => {
    const day = row.created_at.split('T')[0];
    if (!byDay[day]) byDay[day] = new Set();
    byDay[day].add(row.user_id);
  });

  const labels = Object.keys(byDay).slice(-30);
  const values = labels.map(d => byDay[d].size);

  const ctx = document.getElementById('chart-dau').getContext('2d');
  if (dauChart) dauChart.destroy();
  dauChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels.map(d => formatDate(d)),
      datasets: [{ label: 'DAU', data: values, backgroundColor: '#E65100', borderRadius: 4 }]
    },
    options: chartOpts('Users')
  });
}

// ---- SCREEN POPULARITY ----
async function loadScreens() {
  const { data } = await sb.from('analytics_events')
    .select('screen_name')
    .eq('event_type', 'screen_view')
    .not('screen_name', 'is', null);

  if (!data || data.length === 0) return renderEmpty('chart-screens');

  const counts = {};
  data.forEach(row => { counts[row.screen_name] = (counts[row.screen_name] || 0) + 1; });

  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const labels = sorted.map(s => s[0]);
  const values = sorted.map(s => s[1]);
  const colors = ['#E65100','#FF8A65','#FFAB91','#FFCCBC','#FBE9E7','#D84315','#BF360C','#FF5722','#FF7043','#FF9E80'];

  const ctx = document.getElementById('chart-screens').getContext('2d');
  if (screenChart) screenChart.destroy();
  screenChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length) }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#aaa', padding: 12, font: { size: 12 } } }
      }
    }
  });
}

// ---- FEATURE ADOPTION ----
async function loadFeatures() {
  const featureTypes = ['activity_started','activity_completed','activity_saved','territory_claimed','territory_invaded','post_created','post_liked','comment_added','friend_request_sent','share_initiated'];
  const { data } = await sb.from('analytics_events')
    .select('event_type, created_at')
    .in('event_type', featureTypes)
    .order('created_at', { ascending: false });

  if (!data || data.length === 0) { document.getElementById('feature-table').innerHTML = emptyHTML('No feature events yet'); return; }

  const byDay = {};
  data.forEach(row => {
    const day = row.created_at.split('T')[0];
    if (!byDay[day]) byDay[day] = {};
    byDay[day][row.event_type] = (byDay[day][row.event_type] || 0) + 1;
  });

  const days = Object.keys(byDay).sort().reverse().slice(0, 14);
  const featureLabels = { activity_started: 'Started', activity_completed: 'Completed', activity_saved: 'Saved', territory_claimed: 'Territories', territory_invaded: 'Invasions', post_created: 'Posts', post_liked: 'Likes', comment_added: 'Comments', friend_request_sent: 'Friend Reqs', share_initiated: 'Shares' };
  const activeFeatures = featureTypes.filter(f => data.some(d => d.event_type === f));

  let html = '<div style="overflow-x:auto"><table><tr><th>Date</th>';
  activeFeatures.forEach(f => { html += `<th>${featureLabels[f] || f}</th>`; });
  html += '</tr>';
  days.forEach(day => {
    html += `<tr><td>${formatDate(day)}</td>`;
    activeFeatures.forEach(f => { html += `<td>${byDay[day][f] || '-'}</td>`; });
    html += '</tr>';
  });
  html += '</table></div>';
  document.getElementById('feature-table').innerHTML = html;
}

// ---- USER ENGAGEMENT ----
async function loadUsers() {
  const { data } = await sb.from('analytics_events')
    .select('user_id, event_type, session_id, created_at');

  if (!data || data.length === 0) { document.getElementById('user-table').innerHTML = emptyHTML('No user data yet'); return; }

  const users = {};
  data.forEach(row => {
    if (!users[row.user_id]) users[row.user_id] = { sessions: new Set(), screens: 0, activities: 0, territories: 0, first: row.created_at, last: row.created_at, days: new Set() };
    const u = users[row.user_id];
    if (row.session_id) u.sessions.add(row.session_id);
    if (row.event_type === 'screen_view') u.screens++;
    if (row.event_type === 'activity_completed') u.activities++;
    if (row.event_type === 'territory_claimed') u.territories++;
    if (row.created_at < u.first) u.first = row.created_at;
    if (row.created_at > u.last) u.last = row.created_at;
    u.days.add(row.created_at.split('T')[0]);
  });

  const sorted = Object.entries(users).sort((a, b) => b[1].sessions.size - a[1].sessions.size);

  let html = '<div style="overflow-x:auto"><table><tr><th>User</th><th>Sessions</th><th>Screen Views</th><th>Activities</th><th>Territories</th><th>Active Days</th><th>Last Seen</th></tr>';
  sorted.slice(0, 50).forEach(([uid, u]) => {
    html += `<tr><td title="${uid}">${uid.substring(0,8)}...</td><td>${u.sessions.size}</td><td>${u.screens}</td><td>${u.activities}</td><td>${u.territories}</td><td>${u.days.size}</td><td>${timeAgo(u.last)}</td></tr>`;
  });
  html += '</table></div>';
  document.getElementById('user-table').innerHTML = html;
}

// ---- ERRORS ----
async function loadErrors() {
  const { data } = await sb.from('analytics_events')
    .select('*')
    .in('event_type', ['error', 'crash'])
    .order('created_at', { ascending: false })
    .limit(20);

  if (!data || data.length === 0) { document.getElementById('error-table').innerHTML = emptyHTML('No errors -- nice!'); return; }

  let html = '<div style="overflow-x:auto"><table><tr><th>Type</th><th>Message</th><th>Screen</th><th>When</th></tr>';
  data.forEach(row => {
    const meta = row.metadata || {};
    const tag = row.event_type === 'crash' ? 'tag-crash' : 'tag-error';
    html += `<tr><td><span class="tag ${tag}">${row.event_type}</span></td><td title="${esc(meta.stack || '')}">${esc((meta.message || 'Unknown').substring(0, 80))}</td><td>${row.screen_name || '-'}</td><td>${timeAgo(row.created_at)}</td></tr>`;
  });
  html += '</table></div>';
  document.getElementById('error-table').innerHTML = html;
}

// ---- SESSIONS ----
async function loadSessions() {
  const { data } = await sb.from('analytics_events')
    .select('session_id, user_id, event_type, created_at')
    .not('session_id', 'is', null)
    .order('created_at', { ascending: false })
    .limit(5000);

  if (!data || data.length === 0) { document.getElementById('session-table').innerHTML = emptyHTML('No sessions yet'); return; }

  const sessions = {};
  data.forEach(row => {
    if (!row.session_id) return;
    if (!sessions[row.session_id]) sessions[row.session_id] = { user_id: row.user_id, events: 0, start: row.created_at, end: row.created_at };
    const s = sessions[row.session_id];
    s.events++;
    if (row.created_at < s.start) s.start = row.created_at;
    if (row.created_at > s.end) s.end = row.created_at;
  });

  const sorted = Object.entries(sessions).sort((a, b) => new Date(b[1].start) - new Date(a[1].start));

  let html = '<div style="overflow-x:auto"><table><tr><th>User</th><th>Started</th><th>Duration</th><th>Events</th></tr>';
  sorted.slice(0, 30).forEach(([sid, s]) => {
    const dur = Math.round((new Date(s.end) - new Date(s.start)) / 1000);
    html += `<tr><td title="${s.user_id}">${s.user_id.substring(0,8)}...</td><td>${timeAgo(s.start)}</td><td>${formatDuration(dur)}</td><td>${s.events}</td></tr>`;
  });
  html += '</table></div>';
  document.getElementById('session-table').innerHTML = html;
}

// ---- HELPERS ----
function fmt(n) { return n.toLocaleString(); }
function formatDate(d) { const p = d.split('-'); return `${p[1]}/${p[2]}`; }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function emptyHTML(msg) { return `<div class="empty-state"><div class="icon">--</div><p>${msg}</p></div>`; }
function renderEmpty(canvasId) { const c = document.getElementById(canvasId); c.parentElement.innerHTML += emptyHTML('No data yet'); }

function timeAgo(dateStr) {
  const diff = (Date.now() - new Date(dateStr).getTime()) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

function formatDuration(s) {
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s / 60) + 'm ' + (s % 60) + 's';
  return Math.floor(s / 3600) + 'h ' + Math.floor((s % 3600) / 60) + 'm';
}

function chartOpts(yLabel) {
  return {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: '#888' }, grid: { color: '#1f1f1f' } },
      y: { ticks: { color: '#888', precision: 0 }, grid: { color: '#1f1f1f' }, title: { display: true, text: yLabel, color: '#888' } }
    }
  };
}
</script>
</body>
</html>
